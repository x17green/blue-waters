#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ” Running pre-commit checks..."
echo ""

# STRICT RULE: Block commit if ANY errors exist in the codebase
# Checks ALL files, not just staged ones

echo "ğŸ“ Checking TypeScript types..."
npx tsc --noEmit --pretty
TS_EXIT_CODE=$?

echo ""
echo "ğŸ” Running ESLint..."
npx eslint src --max-warnings 50 2>&1 | head -n 30
LINT_EXIT_CODE=$?

if [ $LINT_EXIT_CODE -ne 0 ]; then
  echo "âŒ ESLint errors found"
else
  echo "âœ… ESLint passed"
fi

echo ""

# Check if any errors were found
if [ $TS_EXIT_CODE -ne 0 ] || [ $LINT_EXIT_CODE -ne 0 ]; then
  echo "âŒ PRE-COMMIT BLOCKED: Errors detected in codebase"
  echo ""
  echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
  echo "â”‚  STRICT ERROR POLICY ENFORCED                       â”‚"
  echo "â”‚  All TypeScript and ESLint errors must be fixed    â”‚"
  echo "â”‚  before committing (regardless of staging status)  â”‚"
  echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
  echo ""
  
  if [ $TS_EXIT_CODE -ne 0 ]; then
    echo "âš ï¸  TypeScript errors found - Fix with: npx tsc --noEmit"
  fi
  
  if [ $LINT_EXIT_CODE -ne 0 ]; then
    echo "âš ï¸  ESLint errors found - Fix with: npm run lint -- --fix"
  fi
  
  echo ""
  echo "ğŸ’¡ Tips:"
  echo "   â€¢ Fix all errors before committing"
  echo "   â€¢ Use 'npm run lint -- --fix' for auto-fixable issues"
  echo "   â€¢ Check VSCode Problems panel for details"
  echo ""
  
  exit 1
fi

echo "âœ… All checks passed - proceeding with commit"
echo ""
